<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Liste de Courses</title>
  <link rel="stylesheet" href="/Site/Styles/style_courses.css" />
</head>
<body>

  <!-- ===== BARRE DE NAVIGATION ===== -->
  <nav>
    <a href="index.html">Ingrédients</a>
    <a href="recette.html">Recettes</a>
    <a href="planning.html">Planning Semaine</a>
    <a href="courses.html">Liste de Courses</a>
    <a href="setup.html">Paramètres</a>
  </nav>

  <!-- ===== CONTENEUR PRINCIPAL ===== -->
  <div class="container">
    <section id="courses">
      <h2>Liste de Courses</h2>
      <p class="centered-warning">
        &#9888;&#65039; La liste est générée automatiquement à partir du planning de la semaine &#9888;&#65039;
      </p>
	  
	  <!-- ===== FORMULAIRE AJOUT MANUEL ===== -->
		<div id="manualAdd" style="text-align:center; margin-bottom:20px;">
		  <select id="manualSelect">
			<option value="">Ajouter un ingrédient</option>
		  </select>
		  <input type="number" id="manualQty" placeholder="Quantité">
		  <select id="manualUnit">
			<option value="">Sélectionner une unité</option>
		  </select>
		  <button id="addManualBtn">Ajouter</button>
		</div>
		
		<!-- Bouton pour supprimer tous les ingrédients manuels -->
		<div style="text-align:center; margin-bottom:20px;">
		  <button id="clearManualBtn" style="background-color:#e74c3c; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">
			Supprimer tous les ingrédients manuels
		  </button>
		</div>

      <!-- ===== TABLEAU LISTE DE COURSES ===== -->
      <table class="excel-table dotted-borders" id="coursesTable">
        <thead>
          <tr>
            <th>&#127826; Fruits &amp; Légumes</th>
            <th>&#127831; Viandes &amp; Poissons</th>
            <th>&#129472; Produits Laitiers</th>
            <th>&#129366; Boulangerie &amp; Céréales</th>
            <th>&#129474; Épicerie salée</th>
            <th>&#127851; Épicerie sucrée</th>
            <th>&#10052; Surgelé</th>
            <th>&#127865; Boissons</th>
            <th>&#129533; Produits ménagers</th>
            <th>&#129524; Hygiène &amp; Beauté</th>
          </tr>
        </thead>
        <tbody id="coursesBody">
          <!-- Contenu généré en JS -->
        </tbody>
      </table>
    </section>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCJkZCKpb8poixAGPhYVUfuuafCnjnJh3o",
  authDomain: "liste-de-courses-8a78d.firebaseapp.com",
  projectId: "liste-de-courses-8a78d",
  storageBucket: "liste-de-courses-8a78d.appspot.com",
  messagingSenderId: "90294670968",
  appId: "1:90294670968:web:901f321930a3a6342dbf8d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- Conversion et somme des ingrédients ---
function convertAndSumIngredients(ingredientsRaw) {
  const result = {};

  const massUnits = ['mg', 'g', 'kg'];
  const volUnits  = ['ml', 'cl', 'l'];

  const massToMg = { mg: 1, g: 1000, kg: 1e6 };
  const volToMl  = { ml: 1, cl: 10, l: 1000 };

  Object.keys(ingredientsRaw).forEach(ing => {
    const qtys = ingredientsRaw[ing].qtys;

    // Déterminer type
    const units = qtys.map(q => (q.unit || "").toLowerCase());
    let isMass = units.every(u => massUnits.includes(u));
    let isVol  = units.every(u => volUnits.includes(u));

    let totalBase = 0;
    let preferredUnit = qtys[0].unit || "";

    // Déterminer la plus grande unité d'origine
    if(isMass){
      if(units.includes('kg')) preferredUnit = 'Kg';
      else if(units.includes('g')) preferredUnit = 'g';
      else preferredUnit = 'mg';
    } else if(isVol){
      if(units.includes('l')) preferredUnit = 'L';
      else if(units.includes('cl')) preferredUnit = 'cL';
      else preferredUnit = 'ml';
    }

    // Somme en unité de base
    qtys.forEach(q=>{
      let qty = parseFloat(q.qty.toString().replace(',', '.')) || 0;
      const unit = (q.unit || "").toLowerCase();
      if(isMass) totalBase += (massToMg[unit] || 0) * qty;
      else if(isVol) totalBase += (volToMl[unit] || 0) * qty;
      else totalBase += qty;
    });

    // Convertir dans l'unité préférée
    let finalQty;
    if(isMass){
      if(preferredUnit === 'Kg') finalQty = totalBase / 1e6;
      else if(preferredUnit === 'g') finalQty = totalBase / 1000;
      else finalQty = totalBase;
    } else if(isVol){
      if(preferredUnit === 'L') finalQty = totalBase / 1000;
      else if(preferredUnit === 'cL') finalQty = totalBase / 10;
      else finalQty = totalBase;
    } else finalQty = totalBase;

    finalQty = Math.round(finalQty * 100) / 100;

    result[ing] = { qty: finalQty, unit: preferredUnit };
  });

  return result;
}

// --- Variables ---
let ingredientToCol = {}; 
let manualIngredients = [];
const coursesBody = document.getElementById("coursesBody");
const manualSelect = document.getElementById("manualSelect");
const manualUnit = document.getElementById("manualUnit");

// --- Charger ingrédients et unités (tri alphabétique) ---
async function loadIngredientsList() {
  const snap = await getDocs(collection(db,"ingredients"));
  let ingredients = [];
  snap.forEach(docSnap=>{
    const data = docSnap.data();
    ingredientToCol[data.nom] = data.col;
    ingredients.push(data.nom);
  });
  ingredients.sort((a,b)=>a.localeCompare(b,"fr",{sensitivity:"base"}));
  ingredients.forEach(nom=>{
    const option = document.createElement("option");
    option.value = nom;
    option.textContent = nom;
    manualSelect.appendChild(option);
  });
}

async function loadUnitsList() {
  const snap = await getDocs(collection(db,"Unites"));
  let unites = [];
  snap.forEach(docSnap=>{
    const data = docSnap.data();
    unites.push(data.nom);
  });
  unites.sort((a,b)=>a.localeCompare(b,"fr",{sensitivity:"base"}));
  unites.forEach(nom=>{
    const option = document.createElement("option");
    option.value = nom;
    option.textContent = nom;
    manualUnit.appendChild(option);
  });
}

// --- Charger courses existantes (manuelles) ---
async function loadCoursesData() {
  manualIngredients = [];
  const snap = await getDocs(collection(db,"courses"));
  snap.forEach(docSnap=>{
    const data = docSnap.data();
    if(data.manuel){
      manualIngredients.push({
        nom: docSnap.id,
        qty: data.qty,
        unit: data.unit,
        col: data.col,
        checked: !!data.checked,
        manuel: true
      });
    }
  });
}

// --- Ajouter manuel ---
document.getElementById("addManualBtn").addEventListener("click", async ()=>{
  const name = manualSelect.value;
  const qty = parseFloat(document.getElementById("manualQty").value)||0;
  const unit = manualUnit.value;
  if(!name || !unit) return alert("Sélectionnez un ingrédient et une unité");
  const col = ingredientToCol[name]??0;

  await setDoc(doc(db,"courses",name), { checked:false, qty, unit, col, manuel:true });
  manualIngredients.push({nom:name, qty, unit, col, checked:false, manuel:true});
  renderCourses();
});

// --- Supprimer tout manuel ---
document.getElementById("clearManualBtn")?.addEventListener("click", async ()=>{
  if(!manualIngredients.length) return alert("Aucun ingrédient manuel à supprimer");
  if(!confirm("Supprimer tous les ingrédients manuels ?")) return;
  for(const item of manualIngredients){
    await deleteDoc(doc(db,"courses",item.nom));
  }
  manualIngredients = [];
  renderCourses();
});

// --- Récupérer ingrédients du planning (gestion des deux formats et lecture du checked) ---
async function loadPlanningIngredients() {
  const coursesSnap = await getDocs(collection(db,"courses"));
  const ingredientsRaw = {}; // { ing: { qtys: [...] } }
  const checkedMap = {};     // { ing: true/false }

  coursesSnap.forEach(docSnap => {
    const id = docSnap.id;
    const data = docSnap.data();

    // Skip manual entries (déjà traitées par loadCoursesData)
    if (data && data.manuel) return;

    // Cas 1 : document par ingrédient (doc.id = "Carotte"), champs qty/unit/checked
    if (data && ('qty' in data) && ('unit' in data)) {
      if (!ingredientsRaw[id]) ingredientsRaw[id] = { qtys: [] };
      ingredientsRaw[id].qtys.push({ qty: data.qty, unit: data.unit });
      if (data.checked) checkedMap[id] = true;
    }

    // Cas 2 : document "jour" qui contient des champs ingrédient: {qty,unit,...}
    if (data && typeof data === 'object') {
      Object.keys(data).forEach(key => {
        const val = data[key];
        if (val && typeof val === 'object' && ('qty' in val) && ('unit' in val)) {
          if (!ingredientsRaw[key]) ingredientsRaw[key] = { qtys: [] };
          ingredientsRaw[key].qtys.push({ qty: val.qty, unit: val.unit });
          if (val.checked) checkedMap[key] = true;
        }
      });
    }
  });

  // Somme/conversion
  const summed = convertAndSumIngredients(ingredientsRaw);

  // Injecter l'état checked si présent
  Object.keys(summed).forEach(ing => {
    summed[ing].checked = !!checkedMap[ing];
  });

  return summed;
}

// --- Rendu ---
async function renderCourses() {
  const planningIngredients = await loadPlanningIngredients();
  const cols = Array.from({ length: 10 }, () => []);

  // --- Nettoyage des courses : supprimer les ingrédients du planning qui n'existent plus ---
  const coursesSnap = await getDocs(collection(db, "courses"));
  for (const courseDoc of coursesSnap.docs) {
    const data = courseDoc.data();
    if (!data.manuel) { // seulement si ce n'est pas manuel
      if (!planningIngredients[courseDoc.id]) { // plus dans le planning
        await deleteDoc(doc(db, "courses", courseDoc.id));
      }
    }
  }

  // --- Ajouter les ingrédients du planning avec l'état checked depuis Firebase ---
  for (const ing of Object.keys(planningIngredients)) {
    const col = ingredientToCol[ing] ?? 0;
    let checked = false;

    // Vérifier si cet ingrédient existe déjà dans courses pour récupérer l'état checked
    const courseSnap = await getDocs(collection(db, "courses"));
    const courseDoc = courseSnap.docs.find(d => d.id === ing);
    if (courseDoc) {
      checked = !!courseDoc.data().checked;
    }

    cols[col].push({ nom: ing, ...planningIngredients[ing], checked, manuel: false });
  }

  // Ajouter les ingrédients manuels
  manualIngredients.forEach(item => {
    const col = item.col ?? 0;
    cols[col].push({ ...item, checked: item.checked || false });
  });

  // Trier les colonnes par ordre alphabétique
  cols.forEach(col => col.sort((a, b) => a.nom.localeCompare(b.nom, "fr", { sensitivity: "base" })));

  // Affichage dans le tableau
  coursesBody.innerHTML = "";
  const maxRows = Math.max(0, ...cols.map(c => c.length));
  for (let i = 0; i < maxRows; i++) {
    const tr = document.createElement("tr");
    for (let j = 0; j < 10; j++) {
      const td = document.createElement("td");
      const item = cols[j][i];
      if (item) {
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!item.checked;
        cb.addEventListener("change", async () => {
          await setDoc(doc(db, "courses", item.nom), {
            checked: cb.checked,
            qty: item.qty || 0,
            unit: item.unit || "",
            col: item.col || 0,
            manuel: item.manuel || false
          }, { merge: true });

          item.checked = cb.checked;
          td.style.textDecoration = cb.checked ? "line-through" : "none";
        });

        td.appendChild(cb);
        td.appendChild(document.createTextNode(` ${item.nom} (${item.qty || ""} ${item.unit || ""})`));
        if (item.checked) td.style.textDecoration = "line-through";

        if (item.manuel) {
          const delBtn = document.createElement("span");
          delBtn.textContent = " ❌";
          delBtn.style.color = "red";
          delBtn.style.cursor = "pointer";
          delBtn.addEventListener("click", async () => {
            await deleteDoc(doc(db, "courses", item.nom));
            manualIngredients = manualIngredients.filter(m => m.nom !== item.nom);
            renderCourses();
          });
          td.appendChild(delBtn);
        }
      }
      tr.appendChild(td);
    }
    coursesBody.appendChild(tr);
  }
}


// --- Initialisation ---
(async function init(){
  await loadIngredientsList();
  await loadUnitsList();
  await loadCoursesData();
  renderCourses();
})();
</script>

</body>
</html>


