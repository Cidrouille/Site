<html lang="fr">
<head>
    <!-- ===== M√âTADONN√âES & STYLE ===== -->
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Menu et Liste de Courses</title>
    <link rel="stylesheet" href="/Site/Styles/style_index.css" />
    <script type="module" src="/Site/scripts/main.js"></script>
</head>

<body>
    <!-- ===== BARRE DE NAVIGATION ===== -->
    <nav>
        <a href="index.html">Ingr√©dients</a>
        <a href="recette.html">Recettes</a>
        <a href="planning.html">Planning Semaine</a>
        <a href="courses.html">Liste de Courses</a>
        <a href="setup.html">Param√®tres</a>
    </nav>

    <!-- ===== CONTENEUR PRINCIPAL ===== -->
    <div class="container">

        <!-- ===== SECTION : Ingr√©dients ===== -->
        <section id="ingredients">
            <h2>Ingr√©dients</h2>
            <p class="centered-warning">
                ‚ö†Ô∏è Connexion Internet requise pour sauvegarder toutes modifications ! ‚ö†Ô∏è
            </p>

            <div style="text-align: center; margin-bottom: 1em;">
                <button id="clearAllBtn">Effacer tous les ingr√©dients</button>
            </div>

            <!-- ===== TABLEAU DES INGR√âDIENTS ===== -->
            <table class="excel-table dotted-borders" id="ingredientsTable">
                <thead>
                    <tr>
                        <th>üçé Fruits &amp; L√©gumes</th>
                        <th>üçó Viandes &amp; Poissons</th>
                        <th>üßÄ Produits Laitiers</th>
                        <th>ü•ê Boulangerie &amp; C√©r√©ales</th>
                        <th>ü•´ √âpicerie sal√©e</th>
                        <th>üç´ √âpicerie sucr√©e</th>
                        <th>‚ùÑÔ∏è Surgel√©</th>
                        <th>üçπ Boissons</th>
                        <th>üß¥ Produits m√©nagers</th>
                        <th>üßº Hygi√®ne &amp; Beaut√©</th>
                    </tr>
                    <tr id="inputRow">
                        <th><input type="text" placeholder="Ajouter..." /></th>
                        <th><input type="text" placeholder="Ajouter..." /></th>
                        <th><input type="text" placeholder="Ajouter..." /></th>
                        <th><input type="text" placeholder="Ajouter..." /></th>
                        <th><input type="text" placeholder="Ajouter..." /></th>
                        <th><input type="text" placeholder="Ajouter..." /></th>
                        <th><input type="text" placeholder="Ajouter..." /></th>
                        <th><input type="text" placeholder="Ajouter..." /></th>
                        <th><input type="text" placeholder="Ajouter..." /></th>
                        <th><input type="text" placeholder="Ajouter..." /></th>
                    </tr>
                </thead>
                <tbody id="ingredientsBody"></tbody>
            </table>
        </section>
    </div>

    <!-- ===== SCRIPT PRINCIPAL (Firebase + gestion des ingr√©dients) ===== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        // ===== CONFIGURATION FIREBASE =====
        const firebaseConfig = {
            apiKey: "AIzaSyCJkZCKpb8poixAGPhYVUfuuafCnjnJh3o",
            authDomain: "liste-de-courses-8a78d.firebaseapp.com",
            projectId: "liste-de-courses-8a78d",
            storageBucket: "liste-de-courses-8a78d.appspot.com",
            messagingSenderId: "90294670968",
            appId: "1:90294670968:web:901f321930a3a6342dbf8d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ===== UTILS =====
        const normalize = str => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        const ingredientsData = Array.from({ length: 10 }, () => []);
        const ingredientsIds = Array.from({ length: 10 }, () => []);
        const inputCells = document.querySelectorAll('#inputRow input');
        const tbody = document.getElementById('ingredientsBody');

        // ===== MISE √Ä JOUR DU TABLEAU =====
        function updateIngredientTable() {
            tbody.innerHTML = '';
            const max = Math.max(...ingredientsData.map(col => col.length));
            for (let i = 0; i < max; i++) {
                const tr = document.createElement('tr');
                for (let j = 0; j < 10; j++) {
                    const td = document.createElement('td');
                    const item = ingredientsData[j][i];
                    if (item) {
                        td.textContent = item;
                        const btn = document.createElement('button');
                        btn.textContent = '√ó';
                        btn.className = 'delete-btn';
                        btn.title = 'Supprimer cet ingr√©dient';
                        btn.addEventListener('click', () => deleteIngredient(j, i));
                        td.appendChild(btn);
                    }
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
        }

        // ===== FIRESTORE =====
        async function addToFirestore(colIndex, value) {
            const docRef = await addDoc(collection(db, "ingredients"), { col: colIndex, nom: value });
            ingredientsIds[colIndex].push(docRef.id);
        }

        async function loadFromFirestore() {
            const snapshot = await getDocs(collection(db, "ingredients"));
            const cols = Array.from({ length: 10 }, () => []);
            const ids = Array.from({ length: 10 }, () => []);
            
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                if (typeof data.col === 'number' && typeof data.nom === 'string') {
                    cols[data.col]?.push(data.nom);
                    ids[data.col]?.push(docSnap.id);
                }
            });

            cols.forEach((col, idx) => {
                const paired = col.map((val, i) => ({ val, id: ids[idx][i] }));
                paired.sort((a, b) => normalize(a.val).localeCompare(normalize(b.val)));
                ingredientsData[idx] = paired.map(p => p.val);
                ingredientsIds[idx] = paired.map(p => p.id);
            });

            updateIngredientTable();
        }

        async function deleteIngredient(colIndex, itemIndex) {
            const docId = ingredientsIds[colIndex][itemIndex];
            if (!docId) return;

            try {
                await deleteDoc(doc(db, "ingredients", docId));
                ingredientsData[colIndex].splice(itemIndex, 1);
                ingredientsIds[colIndex].splice(itemIndex, 1);
                updateIngredientTable();
            } catch (err) {
                alert("Erreur lors de la suppression : " + err.message);
            }
        }

        inputCells.forEach((input, colIndex) => {
            input.addEventListener('change', async () => {
                const value = input.value.trim();
                input.value = '';
                if (!value) return;

                const normalizedValue = normalize(value);
                if (ingredientsData[colIndex].some(item => normalize(item) === normalizedValue)) return;

                ingredientsData[colIndex].push(value);
                ingredientsData[colIndex].sort((a, b) => normalize(a).localeCompare(normalize(b)));
                updateIngredientTable();
                await addToFirestore(colIndex, value);
            });
        });

        async function clearAllIngredients() {
            const snapshot = await getDocs(collection(db, "ingredients"));
            const batchDeletes = snapshot.docs.map(docSnap => deleteDoc(doc(db, "ingredients", docSnap.id)));
            await Promise.all(batchDeletes);

            for (let i = 0; i < ingredientsData.length; i++) {
                ingredientsData[i] = [];
                ingredientsIds[i] = [];
            }
            updateIngredientTable();
        }

        document.getElementById('clearAllBtn').addEventListener('click', async () => {
            if (confirm("√ätes-vous s√ªr de vouloir effacer tous les ingr√©dients ?")) {
                await clearAllIngredients();
                alert("Tous les ingr√©dients ont √©t√© effac√©s.");
            }
        });

        await loadFromFirestore();
    </script>

    <!-- ===== SCRIPT POUR NAVIGATION ENTRE SECTIONS ===== -->
    <script>
        function showSection(id) {
            ['ingredients', 'recettes', 'planning', 'courses', 'setup'].forEach(sec => {
                const el = document.getElementById(sec);
                if (el) el.classList.toggle('hidden', sec !== id);
            });
        }
        showSection('ingredients');
    </script>
</body>
</html>
