<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planning Semaine</title>
  <link rel="stylesheet" href="/Site/Styles/style_planning.css" />
</head>
<body>
  <!-- ===== BARRE DE NAVIGATION ===== -->
  <nav>
    <a href="index.html">Ingrédients</a>
    <a href="recette.html">Recettes</a>
    <a href="planning.html">Planning Semaine</a>
    <a href="courses.html">Liste de Courses</a>
    <a href="setup.html">Paramètres</a>
  </nav>

  <!-- ===== CONTENU PRINCIPAL ===== -->
  <div class="container">
    <h2>Planning de la semaine</h2>
    <div style="text-align:center; margin-bottom:1em;">
      <button id="reset-semaine" class="reset-btn">
        &#x267B; Reset Semaine
      </button>
    </div>

    <!-- Barre de scroll horizontale fixe -->
    <div id="scrollbar-container">
      <input type="range" id="scrollbar-range" min="0" max="0" value="0">
    </div>

    <!-- ===== LES 7 JOURS EN COLONNES ===== -->
    <div id="jours-container"></div>
  </div>

  <!-- ===== Firebase + Script ===== -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // === CONFIG FIREBASE ===
    const firebaseConfig = {
      apiKey: "AIzaSyCJkZCKpb8poixAGPhYVUfuuafCnjnJh3o",
      authDomain: "liste-de-courses-8a78d.firebaseapp.com",
      projectId: "liste-de-courses-8a78d",
      storageBucket: "liste-de-courses-8a78d.appspot.com",
      messagingSenderId: "90294670968",
      appId: "1:90294670968:web:901f321930a3a6342dbf8d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const jours = ["lundi","mardi","mercredi","jeudi","vendredi","samedi","dimanche"];

    // === Génération dynamique du HTML pour chaque jour ===
    function generateJourHTML(jour) {
      return `
        <div class="jour-card">
          <h3>${jour.charAt(0).toUpperCase() + jour.slice(1)}</h3>
          <table>
            <thead>
              <tr>
                <th>Repas</th>
                <th>Entrée</th>
                <th>Plat</th>
                <th>Dessert</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><b>Midi</b></td>
                <td><select class="recette-select" data-jour="${jour}" data-repas="midi" data-type="entree"></select></td>
                <td><select class="recette-select" data-jour="${jour}" data-repas="midi" data-type="plat"></select></td>
                <td><select class="recette-select" data-jour="${jour}" data-repas="midi" data-type="dessert"></select></td>
              </tr>
              <tr>
                <td><b>Soir</b></td>
                <td><select class="recette-select" data-jour="${jour}" data-repas="soir" data-type="entree"></select></td>
                <td><select class="recette-select" data-jour="${jour}" data-repas="soir" data-type="plat"></select></td>
                <td><select class="recette-select" data-jour="${jour}" data-repas="soir" data-type="dessert"></select></td>
              </tr>
            </tbody>
          </table>
          <button id="reset-${jour}" class="reset-btn">&#x267B; Reset</button>
          <h4>Récapitulatif</h4>
          <table id="recap-${jour}">
            <thead>
              <tr>
                <th>Ingrédient</th>
                <th>Quantité</th>
                <th>Unité</th>
                <th>Courses</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      `;
    }

    // === Charger les recettes depuis Firestore ===
    async function loadRecettes() {
      const snapshot = await db.collection("recettes").get();
      const recettes = snapshot.docs.map(doc => doc.data().nom);

      document.querySelectorAll(".recette-select").forEach(select => {
        select.innerHTML = `<option value="">-- Choisir --</option>`;
        recettes.forEach(recette => {
          const opt = document.createElement("option");
          opt.value = recette;
          opt.textContent = recette;
          select.appendChild(opt);
        });
      });
    }

    // === Sauvegarder une sélection dans Firestore ===
    function setupSelectSave() {
      document.querySelectorAll(".recette-select").forEach(select => {
        select.addEventListener("change", async () => {
          const jour = select.dataset.jour;
          const repas = select.dataset.repas;
          const type = select.dataset.type;
          const valeur = select.value;

          await db.collection("planning").doc(jour).set(
            { [repas + "_" + type]: valeur },
            { merge: true }
          );

          updateRecapJour(jour);
        });
      });
    }

    // === Charger le planning depuis Firestore ===
    async function loadPlanning() {
      const snapshot = await db.collection("planning").get();
      snapshot.docs.forEach(doc => {
        const data = doc.data();
        Object.keys(data).forEach(key => {
          const [repas, type] = key.split("_");
          const select = document.querySelector(
            `.recette-select[data-jour="${doc.id}"][data-repas="${repas}"][data-type="${type}"]`
          );
          if (select) select.value = data[key];
        });
      });
    }

    // === Reset d'un jour ===
    function setupReset(jour) {
      document.getElementById(`reset-${jour}`).addEventListener("click", async () => {
        document.querySelectorAll(`.recette-select[data-jour="${jour}"]`).forEach(select => {
          select.value = "";
        });
        await db.collection("planning").doc(jour).delete();
        await db.collection("courses").doc(jour).delete();
        updateRecapJour(jour);
      });
    }

    // === Reset de toute la semaine ===
    document.getElementById("reset-semaine").addEventListener("click", async () => {
      if (!confirm("Voulez-vous vraiment réinitialiser toute la semaine ?")) return;
    
      for (const jour of jours) {
        // Vider les selects
        document.querySelectorAll(`.recette-select[data-jour="${jour}"]`).forEach(select => {
          select.value = "";
        });
        // Supprimer le planning et courses dans Firestore
        await db.collection("planning").doc(jour).delete();
        await db.collection("courses").doc(jour).delete();
    
        // Mettre à jour le récap
        updateRecapJour(jour);
      }
    });


    // === Conversion Quantité ===
    function convertToLargestUnit(ingredientsTotal) {
      const result = {};
      const massUnits = ['mg','g','kg'];
      const volUnits = ['ml','cl','l'];

      Object.keys(ingredientsTotal).forEach(ing => {
        const qtys = ingredientsTotal[ing].qtys;
        let finalUnit = qtys[0].unit.toLowerCase();
        let totalQty = 0;

        if (qtys.every(q => massUnits.includes(q.unit.toLowerCase()))) {
          if (qtys.some(q => q.unit.toLowerCase() === 'kg')) finalUnit = 'Kg';
          else if (qtys.some(q => q.unit.toLowerCase() === 'g')) finalUnit = 'g';
          else finalUnit = 'mg';

          qtys.forEach(q => {
            let qty = parseFloat(q.qty);
            const unit = q.unit.toLowerCase();
            if (finalUnit === 'Kg') {
              if (unit === 'g') qty /= 1000;
              else if (unit === 'mg') qty /= 1e6;
            } else if (finalUnit === 'g') {
              if (unit === 'kg') qty *= 1000;
              else if (unit === 'mg') qty /= 1000;
            } else if (finalUnit === 'mg') {
              if (unit === 'kg') qty *= 1e6;
              else if (unit === 'g') qty *= 1000;
            }
            totalQty += qty;
          });
        } else if (qtys.every(q => volUnits.includes(q.unit.toLowerCase()))) {
          if (qtys.some(q => q.unit.toLowerCase() === 'l')) finalUnit = 'L';
          else if (qtys.some(q => q.unit.toLowerCase() === 'cl')) finalUnit = 'cl';
          else finalUnit = 'ml';

          qtys.forEach(q => {
            let qty = parseFloat(q.qty);
            const unit = q.unit.toLowerCase();
            if (finalUnit === 'L') {
              if (unit === 'ml') qty /= 1000;
              else if (unit === 'cl') qty /= 100;
            } else if (finalUnit === 'cl') {
              if (unit === 'ml') qty /= 10;
              else if (unit === 'l') qty *= 100;
            } else if (finalUnit === 'ml') {
              if (unit === 'cl') qty *= 10;
              else if (unit === 'l') qty *= 1000;
            }
            totalQty += qty;
          });
        } else {
          totalQty = qtys.reduce((sum,q)=> sum + parseFloat(q.qty),0);
          finalUnit = qtys[0].unit;
        }

        result[ing] = { qty: totalQty, unit: finalUnit };
      });

      return result;
    }

    // === Récapitulatif ===
    // === Récapitulatif ===
async function updateRecapJour(jour) {
  const recapBody = document.querySelector(`#recap-${jour} tbody`);
  recapBody.innerHTML = '';

  const selectsJour = document.querySelectorAll(`.recette-select[data-jour="${jour}"]`);
  const ingredientsTotal = {};

  for (const select of selectsJour) {
    const recetteNom = select.value;
    if (!recetteNom) continue;

    const snapshot = await db.collection('recettes').where('nom','==',recetteNom).get();
    if (snapshot.empty) continue;

    const recette = snapshot.docs[0].data();
    for (const ligne of recette.lignes || []) {
      const ing = ligne.ingredient;
      const qty = parseFloat(ligne.quantite.replace(',', '.')) || 0;
      const unit = ligne.unite;
      if (!ingredientsTotal[ing]) ingredientsTotal[ing] = { qtys: [] };
      ingredientsTotal[ing].qtys.push({ qty, unit });
    }
  }

  const finalIngredients = convertToLargestUnit(ingredientsTotal);

  const coursesDoc = await db.collection("courses").doc(jour).get();
  const coursesData = coursesDoc.exists ? coursesDoc.data() : {};

  Object.keys(finalIngredients).forEach(async ing => {
    const tr = document.createElement('tr');
    const displayQty = Number(finalIngredients[ing].qty.toFixed(3)).toString();
    const checked = coursesData[ing] ? "checked" : "";

    tr.innerHTML = `
      <td>${ing}</td>
      <td>${displayQty}</td>
      <td>${finalIngredients[ing].unit}</td>
      <td><input type="checkbox" class="acheter-checkbox" data-ingredient="${ing}" ${checked}></td>
    `;

    const checkbox = tr.querySelector('.acheter-checkbox');

    // Quand on coche/décoche
    checkbox.addEventListener('change', async (e) => {
      const checked = e.target.checked;
      const ingredient = e.target.dataset.ingredient;
      const docRef = db.collection('courses').doc(jour);

      if (checked) {
        const docData = {};
        docData[ingredient] = {
          qty: finalIngredients[ingredient].qty,
          unit: finalIngredients[ingredient].unit
        };
        await docRef.set(docData, { merge: true });
      } else {
        await docRef.update({
          [ingredient]: firebase.firestore.FieldValue.delete()
        });
      }
    });

    // ?? Mise à jour automatique si déjà coché
    if (coursesData[ing]) {
      const docRef = db.collection('courses').doc(jour);
      const docData = {};
      docData[ing] = {
        qty: finalIngredients[ing].qty,
        unit: finalIngredients[ing].unit
      };
      await docRef.set(docData, { merge: true });
    }

    recapBody.appendChild(tr);
  });
}


    // === INITIALISATION ===
    document.addEventListener("DOMContentLoaded", async () => {
      const container = document.getElementById("jours-container");
      const scrollbar = document.getElementById("scrollbar-range");

      jours.forEach(jour => {
        container.innerHTML += generateJourHTML(jour);
      });

      await loadRecettes();
      setupSelectSave();
      await loadPlanning();
      jours.forEach(jour => {
        setupReset(jour);
        updateRecapJour(jour);
      });

      // === Config barre de scroll horizontale fixe ===
      function updateScrollbar() {
        scrollbar.max = container.scrollWidth - container.clientWidth;
      }

      // Initialisation
      updateScrollbar();

      // Défilement via la barre
      scrollbar.addEventListener("input", () => {
        container.scrollLeft = scrollbar.value;
      });

      // Défilement manuel du tableau
      container.addEventListener("scroll", () => {
        scrollbar.value = container.scrollLeft;
      });

      // Mettre à jour si la fenêtre change de taille
      window.addEventListener("resize", updateScrollbar);
    });
  </script>
</body>
</html>




